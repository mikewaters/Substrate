{
  "embedding": [
    -0.08610264956951141,
    0.00016618413792457432,
    -0.05505271255970001,
    0.042047467082738876,
    0.032921791076660156,
    -0.08375024795532227,
    -0.029081428423523903,
    0.012060742825269699,
    0.05156247690320015,
    0.05040385574102402,
    -0.008370035327970982,
    -0.006045910529792309,
    0.04405314475297928,
    -0.1074574887752533,
    -0.0703580379486084,
    0.046145498752593994,
    -0.042893629521131516,
    0.04428405314683914,
    -0.03577708452939987,
    -0.04687820374965668,
    -0.006289239507168531,
    0.0695631131529808,
    0.0465521477162838,
    -0.016668999567627907,
    0.03475790470838547,
    0.040345609188079834,
    -0.0709279254078865,
    -0.04615122079849243,
    -0.025614818558096886,
    -0.0656677708029747,
    0.024382347241044044,
    0.07778359949588776,
    -0.06016063317656517,
    0.03649527579545975,
    0.03732634335756302,
    0.03344952315092087,
    0.029194381088018417,
    -0.04440084099769592,
    -0.04788621887564659,
    -0.023032478988170624,
    0.06628476828336716,
    -0.022473569959402084,
    -0.06419549882411957,
    -0.0015196716412901878,
    -0.0451926626265049,
    -0.017722606658935547,
    -0.07145330309867859,
    -0.03985520452260971,
    -0.0059266830794513226,
    0.012821489945054054,
    -0.07471606880426407,
    -0.023098543286323547,
    -0.05236350744962692,
    0.07914487272500992,
    0.05149879679083824,
    0.02121426723897457,
    0.02977137826383114,
    0.009989393875002861,
    -0.04984815791249275,
    -0.030192142352461815,
    0.07476066797971725,
    -0.04902903363108635,
    0.03424248844385147,
    -0.031886860728263855,
    -0.0233316533267498,
    0.03140035644173622,
    0.0056693702936172485,
    0.017082396894693375,
    0.13483653962612152,
    -0.04188227280974388,
    -0.0191400945186615,
    0.0876888632774353,
    -0.13348694145679474,
    -0.007382950279861689,
    -0.038371894508600235,
    0.02715570107102394,
    0.062155917286872864,
    0.025160670280456543,
    -0.01391918957233429,
    -0.10551362484693527,
    -0.04718094319105148,
    -0.045427802950143814,
    0.01780613511800766,
    0.005475800950080156,
    -0.030660292133688927,
    -0.08370906114578247,
    0.025301333516836166,
    -0.009803681634366512,
    0.04986060783267021,
    0.0023504786659032106,
    -0.03460688889026642,
    -0.00042265435331501067,
    0.041877374053001404,
    -0.059654708951711655,
    -0.010843894444406033,
    0.06746511161327362,
    -0.020478837192058563,
    0.04187911003828049,
    0.059530019760131836,
    0.04154159501194954,
    -0.006332379765808582,
    0.032038141041994095,
    -0.03694925457239151,
    0.020284704864025116,
    0.005347504746168852,
    -0.02488454058766365,
    0.010159504599869251,
    0.011372699402272701,
    -0.03833124414086342,
    -0.040242552757263184,
    0.03517666086554527,
    0.01820817030966282,
    0.005582087207585573,
    -0.009112146683037281,
    0.05198729410767555,
    0.05644556134939194,
    -0.012696607038378716,
    0.018884046003222466,
    -0.07242978364229202,
    0.1041894182562828,
    0.06930195540189743,
    0.043453365564346313,
    0.024125002324581146,
    -0.011431071907281876,
    -0.029502203688025475,
    -0.04269247502088547,
    0.013971538282930851,
    6.803593794614408e-33,
    0.037696171551942825,
    -0.06820175051689148,
    0.006607303395867348,
    -0.0022832632530480623,
    0.034480608999729156,
    0.026431681588292122,
    0.042320191860198975,
    0.0423416905105114,
    -0.043622784316539764,
    0.013057627715170383,
    -0.12491150200366974,
    0.08912521600723267,
    -0.09237952530384064,
    -0.03944437950849533,
    -0.016646912321448326,
    -0.0936492457985878,
    -0.005338666960597038,
    0.06746524572372437,
    0.05684339627623558,
    -0.008029506541788578,
    0.10643864423036575,
    -0.033562976866960526,
    -0.07266592234373093,
    -0.06883420050144196,
    0.0038093593902885914,
    0.01868905872106552,
    0.0020519201643764973,
    -0.029359200969338417,
    -0.06810317933559418,
    -0.004657282494008541,
    -0.029816754162311554,
    -0.019217604771256447,
    0.022659778594970703,
    -0.00579014141112566,
    -0.056287072598934174,
    -0.053352244198322296,
    -0.031135156750679016,
    0.021996401250362396,
    -0.03254397213459015,
    -0.045576129108667374,
    0.009320461191236973,
    0.04594499617815018,
    -0.029509391635656357,
    -0.06316346675157547,
    -0.06421314179897308,
    -0.0334734283387661,
    -0.07495247572660446,
    0.06459545344114304,
    0.06292922794818878,
    0.044009801000356674,
    0.07404554635286331,
    0.014004512690007687,
    0.012821315787732601,
    -0.008878521621227264,
    -0.057695601135492325,
    -0.01963738538324833,
    -0.00411198241636157,
    0.023425515741109848,
    0.0870465338230133,
    0.05494223162531853,
    -0.007196526043117046,
    0.038883183151483536,
    -0.038719456642866135,
    0.04522811993956566,
    0.09711731225252151,
    0.05094209313392639,
    0.06576687842607498,
    0.04908517748117447,
    0.057668935507535934,
    0.032870449125766754,
    -0.06166543439030647,
    0.02903367020189762,
    0.030137643218040466,
    -0.0491090789437294,
    0.0835682675242424,
    -0.14407041668891907,
    -0.04345516487956047,
    -0.025852685794234276,
    -0.1261819452047348,
    0.001585781225003302,
    -0.020775768905878067,
    -0.01329597644507885,
    -0.043976958841085434,
    -0.03086608462035656,
    0.022159447893500328,
    0.024296481162309647,
    -0.00791243463754654,
    -0.05911397561430931,
    -0.1282527595758438,
    -0.0021041929721832275,
    0.03321908786892891,
    -0.03408787399530411,
    0.02013222686946392,
    -0.06063734367489815,
    0.028754770755767822,
    -7.074877319633052e-33,
    0.01634409837424755,
    -0.04578438028693199,
    -0.00559989083558321,
    0.02782435342669487,
    0.03225896507501602,
    0.0028676758520305157,
    -0.0012563414638862014,
    0.058577414602041245,
    -0.007557428441941738,
    -0.062370665371418,
    -0.02764997072517872,
    -0.0013933968730270863,
    -0.01522878184914589,
    -0.0550665520131588,
    0.02786152996122837,
    0.008171116933226585,
    -0.05304485186934471,
    -0.08575097471475601,
    -0.03295717388391495,
    0.08075623959302902,
    -0.06817789375782013,
    0.09335291385650635,
    -0.07095572352409363,
    0.04844466224312782,
    -0.04424118250608444,
    0.021638810634613037,
    0.014758361503481865,
    0.03050391934812069,
    -0.033283334225416183,
    -0.05602814629673958,
    0.01996195875108242,
    0.022209130227565765,
    -0.16047422587871552,
    -0.041704751551151276,
    -0.02146366611123085,
    -0.09798768162727356,
    0.005101378075778484,
    0.03731035068631172,
    -0.06420926749706268,
    0.08365501463413239,
    0.05698004737496376,
    0.06922496855258942,
    -0.09728413820266724,
    0.005002021323889494,
    0.004665765445679426,
    0.03281352296471596,
    -0.007709853816777468,
    0.04315977543592453,
    -0.0028890797402709723,
    -0.004151438362896442,
    0.041055209934711456,
    -0.034431055188179016,
    -0.044213008135557175,
    0.045088090002536774,
    0.03946022689342499,
    0.011759556829929352,
    0.008292554877698421,
    0.0069902255199849606,
    -0.07889875769615173,
    -0.019300440326333046,
    0.04439867287874222,
    -0.003206112189218402,
    -0.03064137138426304,
    -0.04525592550635338,
    0.04869117960333824,
    0.036970462650060654,
    -0.07029469311237335,
    0.005565779283642769,
    -0.07593975961208344,
    0.02298157475888729,
    0.017779627814888954,
    0.004854476545006037,
    0.01337551511824131,
    -0.020250150933861732,
    0.07067815214395523,
    0.011713918298482895,
    0.0006458903080783784,
    -0.08771467208862305,
    0.017174549400806427,
    0.07508929818868637,
    -0.15856942534446716,
    0.0900106206536293,
    0.014450530521571636,
    0.0003595027083065361,
    -0.004550396464765072,
    0.0024482570588588715,
    -0.06994199752807617,
    0.07972557842731476,
    0.07861936837434769,
    0.03782143443822861,
    -0.062324728816747665,
    0.0012033178936690092,
    -0.0860118418931961,
    -0.046678684651851654,
    -0.006462815683335066,
    -5.662520408122873e-8,
    -0.0654650330543518,
    0.048521917313337326,
    -0.06259404122829437,
    0.17012609541416168,
    0.06156419962644577,
    0.03138918802142143,
    0.01876302808523178,
    0.13372808694839478,
    -0.019935159012675285,
    -0.08828563243150711,
    0.08250132203102112,
    0.026270896196365356,
    -0.04888078197836876,
    -0.042187876999378204,
    0.02201470546424389,
    -0.024829022586345673,
    0.07598564773797989,
    -0.033742282539606094,
    -0.04503931477665901,
    -0.030895689502358437,
    -0.007637514732778072,
    0.012736733071506023,
    0.0394725538790226,
    0.004573057871311903,
    0.020189709961414337,
    -0.0181756429374218,
    0.08834514766931534,
    0.03910006582736969,
    0.061708614230155945,
    0.007231679745018482,
    0.0733192190527916,
    -0.06549064815044403,
    0.012760666199028492,
    0.026437649503350258,
    0.010575228370726109,
    0.03319380059838295,
    0.06433012336492538,
    0.056741781532764435,
    -0.04555172100663185,
    0.04247920960187912,
    0.026661232113838196,
    0.04381256178021431,
    -0.03845483064651489,
    0.00016847500228323042,
    -0.03349621593952179,
    -0.023224715143442154,
    -0.04262376204133034,
    0.015830930322408676,
    0.0792657807469368,
    0.0034896982833743095,
    -0.0405438132584095,
    -0.08540632575750351,
    -0.025569219142198563,
    0.0695836991071701,
    0.05214500054717064,
    -0.02950960583984852,
    0.042453061789274216,
    -0.009605993516743183,
    0.0017632025992497802,
    0.030893508344888687,
    0.09966053813695908,
    -0.07285289466381073,
    0.07336515933275223,
    0.009847083128988743
  ],
  "text": "### High-Level Flow: Source → Pipeline → Persistence\n\nThe ingestion process flows through:\n1. **Source Creation** - Sources yield Documents with metadata\n2. **IngestionPipeline** - LlamaIndex's pipeline runs transforms on documents\n3. **PersistenceTransform** - Custom transform that writes to database\n4. **FTS Indexing** - Full-text search updates happen during persistence\n\n### Key Classes and Responsibilities\n\n**DatasetIngestPipeline.ingest_dataset()** (lines 79-194):\n- Entry point that orchestrates the entire flow\n- Creates or retrieves dataset via DatasetService.create_or_update()\n- Creates PersistenceTransform with dataset_id and force flag\n- If force=True: clears cache AND deletes vectors via VectorStoreManager\n- Runs pipeline with source.documents\n- Collects stats from persist.stats\n\n**IngestPipeline** (lines 222-684):\n- Alternative implementation with more complete transformation chain\n- Can use docstore caching with DocstoreStrategy (UPSERTS, UPSERTS_AND_DELETE, DUPLICATES_ONLY)\n- Vector store integration for native embedding persistence\n\n### Change Detection Mechanism (PersistenceTransform._process_node)\n\n**Location**: catalog/transform/llama.py lines 472-565\n\nThe logic:\n1. Extract path from node.metadata[\"relative_path\"] or node.node_id\n2. Compute content_hash = SHA256(body) via _compute_content_hash() (line 304)\n3. Pre-fetch existing documents by path (lines 410-417)\n4. For each node, check if document already exists:\n\n**Decision Tree**:\n```\nif existing document found:\n  if NOT force AND existing.content_hash == new_content_hash:\n    # UNCHANGED CONTENT\n    if existing.active == False:\n      # Was soft-deleted, reactivate and update metadata\n      existing.active = True\n      fts.upsert(...)\n      stats.updated += 1\n    else:\n      # Already active, truly no change\n      stats.skipped += 1\n  else:\n    # CHANGED OR FORCE=TRUE\n    existing.content_hash = new_content_hash\n    existing.body = body\n    existing.active = True\n    fts.upsert(...)\n    stats.updated += 1\nelse:\n  # NEW DOCUMENT\n  doc_repo.create(...)\n  fts.upsert(...)\n  stats.created += 1\n```\n\n### Content Hash Storage\n\n**Document model** (catalog/store/models.py lines 169-236):\n- `content_hash: str` field on Document (line 201)\n- Indexed via `ix_documents_content_hash` (line 227)\n- Stored as SHA256 hexdigest (64 chars)\n\n### Force Flag Behavior\n\n**In DatasetIngestPipeline.ingest_dataset()**:\n- Lines 137-142: If force=True:\n  - Clears pipeline docstore cache via `clear_cache(normalized_name)`\n  - Deletes all vectors for dataset via `vector_manager.delete_by_dataset(normalized_name)`\n  \n**In PersistenceTransform._process_node()**:\n- Line 505: If NOT force AND hashes match → skip\n- Line 524: If force OR hash changed → update (regardless of hash)\n\n### Key Metadata Fields\n\nFrom node.metadata in PersistenceTransform._process_node():\n- `relative_path` - Document path within dataset (PRIMARY KEY with parent_id)\n- `etag` - Optional source etag for change detection\n- `last_modified` - Optional source modification time\n- `title` - Document title\n- `description` - Document description\n- `_ontology_meta` - Structured metadata from FrontmatterTransform\n- Other fields are filtered and stored as JSON\n\n### FTS Indexing\n\n**FTSManager.upsert()** called for each document:\n- Updates documents_fts table with full-text index\n- Rows identified by doc.id (Database Document ID)\n- Content indexed from node body\n\n### Chunk Persistence (ChunkPersistenceTransform)\n\n**Location**: catalog/transform/llama.py lines 600-874\n\nChunks from MarkdownNodeParser get:\n- Stable node_id = `{content_hash}:{chunk_seq}`\n- Metadata fields: source_doc_id, chunk_seq, chunk_pos, doc_id\n- FTS5 upsert to chunks_fts table\n- Content hash inherited from parent document\n\n### Pipeline Caching (cache.py)\n\n**persist_pipeline()** (lines 116-130):\n- Saves pipeline's internal docstore to disk\n- Docstore tracks document hashes for LlamaIndex deduplication\n- Only called manually, NOT automatic in current flow\n\n**clear_cache()** (lines 148-162):\n- Removes entire cache directory (pipeline_storage/{dataset_name}/)\n- Called when force=True\n\n**Note**: The cache is NOT actively used in current flow because:\n- IngestionPipeline created with empty SimpleDocumentStore() (line 161)\n- Pipeline is NOT reloaded with cached state before running\n- So docstore deduplication NOT happening at LlamaIndex level\n\n### Critical Finding: Inactive Document Logic\n\nLines 507-521 in _process_node():\n- If document exists but inactive (active=False), and content hash unchanged:\n  - Still counts as updated, not skipped\n  - Reactivates the document\n  - Updates FTS\n  - This is soft-delete recovery, not typical \"unchanged\" skip\n\n### Summary of Change Detection\n\n**Layer 1: Content-based** (PersistenceTransform)\n- Hash computed from normalized body\n- Compared against existing.content_hash\n- If changed or force=True → update\n\n**Layer 2: Source-based metadata** (Not currently used for decision)\n- etag field stored but not compared\n- last_modified field stored but not compared\n- Could be added for optimization\n\n**Layer 3: LlamaIndex docstore** (Not currently active)\n- Could use UPSERTS strategy for automatic deduplication\n- Currently bypassed by creating empty SimpleDocumentStore()",
  "sections": [
    "Project Notes",
    "Ingestion Flow Analysis - Complete Picture"
  ],
  "timestamp": 1770072568822,
  "path": "/Users/mike/Develop/lifeos/substrate/.private-journal/2026-02-02/17-49-28-822087.md"
}